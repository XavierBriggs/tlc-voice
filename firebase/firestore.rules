rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================================================
    // HELPER FUNCTIONS
    // ==========================================================================

    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Get user document data
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is active
    function isActiveUser() {
      return isAuthenticated() && getUserData().active == true;
    }

    // Check if user has specific role
    function hasRole(role) {
      return isActiveUser() && getUserData().role == role;
    }

    // Check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }

    // Check if user is loan officer
    function isLoanOfficer() {
      return hasRole('loan_officer');
    }

    // Check if user is dealer
    function isDealer() {
      return hasRole('dealer');
    }

    // Check if user is TLC staff (LO or admin)
    function isTLCStaff() {
      return isLoanOfficer() || isAdmin();
    }

    // Check if user owns a lead
    function ownsLead(lead) {
      return lead.human.owner_user_id == request.auth.uid;
    }

    // Check if lead is unclaimed
    function isUnclaimed(lead) {
      return lead.human.state == 'unclaimed' && lead.human.owner_user_id == null;
    }

    // ==========================================================================
    // LEADS COLLECTION
    // ==========================================================================
    match /leads/{leadId} {
      // TLC staff can read all leads
      // Dealers can read only their assigned leads
      allow read: if isTLCStaff() ||
        (isDealer() && resource.data.assignment.assigned_dealer_id == getUserData().dealer_id);

      // TLC staff can update leads they own OR unclaimed leads (for claiming)
      // Admins can update any lead
      allow update: if isTLCStaff() && (
        ownsLead(resource.data) ||
        isUnclaimed(resource.data) ||
        isAdmin()
      );

      // Create and delete only through Cloud Functions (Admin SDK)
      allow create, delete: if false;
    }

    // ==========================================================================
    // DEALERS COLLECTION
    // ==========================================================================
    match /dealers/{dealerId} {
      // TLC staff can read all dealers
      // Dealers can read their own dealer record
      allow read: if isTLCStaff() ||
        (isDealer() && getUserData().dealer_id == dealerId);

      // Only admins can modify dealers
      allow write: if isAdmin();

      // Subcollections follow same rules
      match /locations/{locationId} {
        allow read: if isTLCStaff() ||
          (isDealer() && getUserData().dealer_id == dealerId);
        allow write: if isAdmin();
      }

      match /contacts/{contactId} {
        allow read: if isTLCStaff() ||
          (isDealer() && getUserData().dealer_id == dealerId);
        allow write: if isAdmin();
      }
    }

    // ==========================================================================
    // USERS COLLECTION
    // ==========================================================================
    match /users/{userId} {
      // Users can read their own document
      // Admins can read all user documents
      // TLC staff can read all users (for reassignment dropdowns)
      allow read: if isAuthenticated() && (
        request.auth.uid == userId || isTLCStaff()
      );

      // Users can update their own preferences only
      // Admins can update any user
      allow update: if isAuthenticated() && (
        (request.auth.uid == userId &&
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['preferences', 'updated_at'])) ||
        isAdmin()
      );

      // Only admins can create/delete users
      allow create, delete: if isAdmin();
    }

    // ==========================================================================
    // LEAD EVENTS COLLECTION
    // ==========================================================================
    match /leadEvents/{eventId} {
      // TLC staff can read events for any lead
      allow read: if isTLCStaff();

      // TLC staff can create events (for logging actions)
      allow create: if isTLCStaff();

      // Events are append-only - no updates or deletes
      allow update, delete: if false;
    }

    // ==========================================================================
    // REFERENCE COLLECTIONS (Read-only for CRM)
    // ==========================================================================
    match /dealerNumbers/{phoneE164} {
      allow read: if isTLCStaff();
      allow write: if isAdmin();
    }

    match /zipCoverage/{stateZip} {
      allow read: if isTLCStaff();
      allow write: if isAdmin();
    }

    match /dealerAttributionKeys/{keyId} {
      allow read: if isTLCStaff();
      allow write: if isAdmin();
    }

    match /dealerCapacity/{dealerId} {
      allow read: if isTLCStaff();
      allow write: if isAdmin();
    }

    // ==========================================================================
    // MAIL COLLECTION (Trigger Email extension)
    // ==========================================================================
    match /mail/{mailId} {
      // Only Cloud Functions (Admin SDK) can access
      allow read, write: if false;
    }
  }
}
